caption: CloudFlare Saver
tags: $:/tags/ControlPanel/Saving

\define config-base() $:/config/cloudflare-saver/

!! ~CloudFlare Saver

<$checkbox tiddler={{{ [<config-base>addsuffix[enabled]] }}} field="text" checked="yes" unchecked="no" default="no"> Enable saving to Cloudflare Functions</$checkbox>

<div class="tc-control-panel-hint">
Save your TiddlyWiki to GitHub via Cloudflare Functions with password authentication. Works as an additional save option alongside your existing save methods.
</div>

<$reveal state={{{ [<config-base>addsuffix[enabled]] }}} type="match" text="yes" animate="yes">

!!! Cloudflare Function Endpoint URL

<$edit-text tiddler={{{ [<config-base>addsuffix[endpoint]] }}} field="text" default="" placeholder="https://your-site.pages.dev/functions/save" class="tc-edit-texteditor"/>

<div class="tc-control-panel-hint">
The full URL to your deployed Cloudflare Function endpoint (e.g., `https://my-wiki.pages.dev/functions/save`)
</div>

!!! Advanced Options

<$checkbox tiddler={{{ [<config-base>addsuffix[notifications]] }}} field="text" checked="yes" unchecked="no" default="yes"> Show save notifications</$checkbox>

<$checkbox tiddler={{{ [<config-base>addsuffix[auto-retry]] }}} field="text" checked="yes" unchecked="no" default="yes"> Auto-retry failed saves (up to 3 attempts)</$checkbox>

<$checkbox tiddler={{{ [<config-base>addsuffix[remember-password]] }}} field="text" checked="yes" unchecked="no" default="no"> Remember password during session</$checkbox>

<div class="tc-control-panel-hint">
‚ö†Ô∏è Password is stored in memory only and cleared on page reload. Only enable on trusted devices.
</div>

<$checkbox tiddler={{{ [<config-base>addsuffix[debug]] }}} field="text" checked="yes" unchecked="no" default="no"> Enable debug logging to console</$checkbox>

!!! Request Timeout

<$edit-text tiddler={{{ [<config-base>addsuffix[timeout]] }}} field="text" default="30" class="tc-edit-texteditor" size="10"/> seconds

<div class="tc-control-panel-hint">
How long to wait for save requests before timing out (minimum 5 seconds)
</div>

!!! Setup Instructions

<$details summary="Click to expand setup guide">

''1. Create Cloudflare Pages Site''

# Go to [[Cloudflare Pages|https://pages.cloudflare.com/]]
# Connect your GitHub account and create a Pages project from your TiddlyWiki repository
# Deploy your site (e.g., `https://my-tiddlywiki.pages.dev`)

''2. Create GitHub Personal Access Token''

# Go to GitHub ‚Üí Settings ‚Üí Developer settings ‚Üí [[Personal access tokens|https://github.com/settings/tokens]]
# Click "Generate new token (classic)"
# Select scope: `repo` (Full control of private repositories)
# Copy the token securely

''3. Create Cloudflare Function''

Create a file at `functions/save.js` in your repository root. The complete, production-ready function code is available at:

https://github.com/BenSweaterVest/tiddlywiki-cloudflare-saver/blob/main/demo/functions/save.js

The function includes password authentication, rate limiting, content validation, retry logic, and proper UTF-8 handling.

''4. Set Environment Variables''

In Cloudflare Pages ‚Üí Settings ‚Üí Environment Variables ‚Üí Production:

|!Variable |!Type |!Description |
|`GITHUB_TOKEN` |üîê Secret |GitHub Personal Access Token (with `repo` scope) |
|`GITHUB_REPO` |üìù Text |Repository in format `username/repo-name` |
|`SAVE_PASSWORD` |üîê Secret |Password for authenticating saves |
|`FILE_PATH` |üìù Text |Path to TiddlyWiki file (optional, default: `index.html`) |
|`MAX_CONTENT_SIZE` |üìù Text |Max file size in bytes (optional, default: 52428800 = 50MB) |
|`ALLOWED_ORIGINS` |üìù Text |Comma-separated origins for CORS (optional, default: `*`) |

Mark `GITHUB_TOKEN` and `SAVE_PASSWORD` as encrypted/secret variables.

''5. Configure and Test''

# Enter your Cloudflare Function URL above
# Use the TiddlyWiki save button - you'll be prompted for your password
# Check for success notification

</$details>

!!! Test Connection

<$button class="tc-btn-big-green">
{{$:/core/images/save-button}} Test Cloudflare Save
<$action-sendmessage $message="tm-save-wiki" param="cloudflare"/>
</$button>

<div class="tc-control-panel-hint">
This will attempt to save your wiki to test the connection. You'll be prompted for your password.
</div>

</$reveal>
