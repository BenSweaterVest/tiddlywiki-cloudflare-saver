caption: CloudFlare Saver
tags: $:/tags/ControlPanel/Saving

\define config-base() $:/config/cloudflare-saver/

!! ~CloudFlare Saver

<$checkbox tiddler={{{ [<config-base>addsuffix[enabled]] }}} field="text" checked="yes" unchecked="no" default="no"> Enable saving to Cloudflare Functions</$checkbox>

<div class="tc-control-panel-hint">
Save your TiddlyWiki to GitHub via Cloudflare Functions with password authentication. Works as an additional save option alongside your existing save methods.
</div>

<$reveal state={{{ [<config-base>addsuffix[enabled]] }}} type="match" text="yes" animate="yes">

!!! Connection Status

<div style="padding: 10px; background-color: #f8f9fa; border-radius: 4px; margin: 10px 0;">
<$list filter="[[$:/config/cloudflare-saver/stats/last-save-status]get[text]match[success]]">
<span style="color: green;">‚óè</span> ''Last Save:'' Successful at <$view tiddler="$:/config/cloudflare-saver/stats/last-save-status" field="last-save-time"/>
</$list>
<$list filter="[[$:/config/cloudflare-saver/stats/last-save-status]get[text]match[failure]]">
<span style="color: red;">‚óè</span> ''Last Save:'' Failed at <$view tiddler="$:/config/cloudflare-saver/stats/last-save-status" field="last-save-time"/>
<br>''Error:'' <$view tiddler="$:/config/cloudflare-saver/stats/last-save-status" field="last-save-error"/>
</$list>
<$list filter="[[$:/config/cloudflare-saver/stats/last-save-status]!has[text]]">
<span style="color: gray;">‚óè</span> ''Status:'' No saves yet
</$list>
</div>

!!! Save Statistics

<div style="padding: 10px; background-color: #f8f9fa; border-radius: 4px; margin: 10px 0;">
''Successful Saves:'' <$text text={{{ [[$:/config/cloudflare-saver/stats/successful-saves]get[text]else[0]] }}}/>
<br>
''Failed Saves:'' <$text text={{{ [[$:/config/cloudflare-saver/stats/failed-saves]get[text]else[0]] }}}/>
<br>
<$button class="tc-btn-invisible tc-tiddlylink">
üîÑ Reset Statistics
<$action-deletetiddler $tiddler="$:/config/cloudflare-saver/stats/successful-saves"/>
<$action-deletetiddler $tiddler="$:/config/cloudflare-saver/stats/failed-saves"/>
<$action-deletetiddler $tiddler="$:/config/cloudflare-saver/stats/last-save-status"/>
</$button>
</div>

!!! Cloudflare Function Endpoint URL

<$edit-text tiddler={{{ [<config-base>addsuffix[endpoint]] }}} field="text" default="" placeholder="https://your-site.pages.dev/save" tag="input" type="url" class="tc-edit-text"/>

<div class="tc-control-panel-hint">
The full URL to your deployed Cloudflare Function endpoint (e.g., `https://my-wiki.pages.dev/save`)
</div>

!!! Advanced Options

<$checkbox tiddler={{{ [<config-base>addsuffix[notifications]] }}} field="text" checked="yes" unchecked="no" default="yes"> Show save notifications</$checkbox>

<$checkbox tiddler={{{ [<config-base>addsuffix[auto-retry]] }}} field="text" checked="yes" unchecked="no" default="yes"> Auto-retry failed saves (up to 3 attempts)</$checkbox>

<$checkbox tiddler={{{ [<config-base>addsuffix[remember-password]] }}} field="text" checked="yes" unchecked="no" default="no"> Remember password during session</$checkbox>

<$reveal state={{{ [<config-base>addsuffix[remember-password]] }}} type="match" text="yes">
<div style="margin-left: 25px;">
<$button class="tc-btn-invisible tc-tiddlylink">
üîë Clear Remembered Password
<$action-clear-cloudflare-password/>
</$button>
</div>
</$reveal>

<div class="tc-control-panel-hint">
Password is stored in memory only and cleared on page reload. Only enable on trusted devices.
</div>

<$checkbox tiddler={{{ [<config-base>addsuffix[debug]] }}} field="text" checked="yes" unchecked="no" default="no"> Enable debug logging to console</$checkbox>

!!! Request Timeout

<$edit-text tiddler={{{ [<config-base>addsuffix[timeout]] }}} field="text" default="30" tag="input" type="number" min="5" class="tc-edit-text" size="10"/> seconds

<div class="tc-control-panel-hint">
How long to wait for save requests before timing out (minimum 5 seconds)
</div>

!!! Quick Setup Wizard

<$button class="tc-btn-big-green">
üöÄ Launch Setup Wizard
<$action-navigate $to="$:/plugins/BenSweaterVest/cloudflare-saver/wizard"/>
</$button>

<div class="tc-control-panel-hint">
Step-by-step guided setup for first-time users
</div>

!!! Setup Instructions

<$button set="$:/state/cloudflare-saver/show-setup" setTo="yes" class="">
<$list filter="[[$:/state/cloudflare-saver/show-setup]get[text]match[yes]]" emptyMessage="‚ñ∂ Click to expand setup guide">
‚ñº Click to hide setup guide
</$list>
</$button>

<$reveal state="$:/state/cloudflare-saver/show-setup" type="match" text="yes" animate="yes">

''1. Create Cloudflare Pages Site''

# Go to [[Cloudflare Pages|https://pages.cloudflare.com/]]
# Connect your GitHub account and create a Pages project from your TiddlyWiki repository
# Deploy your site (e.g., `https://my-tiddlywiki.pages.dev`)

''2. Create GitHub Personal Access Token''

# Go to GitHub ‚Üí Settings ‚Üí Developer settings ‚Üí [[Personal access tokens|https://github.com/settings/tokens]]
# Click "Generate new token (classic)"
# Select scope: `repo` (Full control of private repositories)
# Copy the token securely

''3. Create Cloudflare Function''

Create a file at `functions/save.js` in your repository root. The complete, production-ready function code is available at:

https://github.com/BenSweaterVest/tiddlywiki-cloudflare-saver/blob/main/demo/functions/save.js

The function includes password authentication, rate limiting, content validation, retry logic, and proper UTF-8 handling.

''4. Set Environment Variables''

In Cloudflare Pages ‚Üí Settings ‚Üí Environment Variables ‚Üí Production:

|!Variable |!Type |!Description |
|`GITHUB_TOKEN` |Secret |GitHub Personal Access Token (with `repo` scope) |
|`GITHUB_REPO` |Text |Repository in format `username/repo-name` |
|`SAVE_PASSWORD` |Secret |Password for authenticating saves |
|`FILE_PATH` |Text |Path to TiddlyWiki file (optional, default: `index.html`) |
|`MAX_CONTENT_SIZE` |Text |Max file size in bytes (optional, default: 52428800 = 50MB) |
|`ALLOWED_ORIGINS` |Text |Comma-separated origins for CORS (optional, default: `*`) |

Mark `GITHUB_TOKEN` and `SAVE_PASSWORD` as encrypted/secret variables.

''5. Configure and Test''

# Enter your Cloudflare Function URL above
# Use the TiddlyWiki save button - you'll be prompted for your password
# Check for success notification

</$reveal>

!!! Test Connection

<$button class="tc-btn-big-green">
{{$:/core/images/save-button}} Test Cloudflare Save
<$action-test-cloudflare/>
</$button>

<div class="tc-control-panel-hint">
This will test your Cloudflare Function connection without triggering other savers. You'll be prompted for your password and will see a clear success or error message.
</div>

</$reveal>
