{
  "tiddlers": {
    "$:/plugins/BenSweaterVest/cloudflare-saver/plugin.info": {
      "title": "$:/plugins/BenSweaterVest/cloudflare-saver/plugin.info",
      "type": "application/json",
      "text": "{\n  \"title\": \"$:/plugins/BenSweaterVest/cloudflare-saver\",\n  \"description\": \"Save TiddlyWiki to GitHub via Cloudflare Functions with password authentication\",\n  \"author\": \"BenSweaterVest\",\n  \"version\": \"1.0.0\",\n  \"core-version\": \">=5.1.22\",\n  \"source\": \"https://github.com/BenSweaterVest/tiddlywiki-cloudflare-saver\",\n  \"plugin-type\": \"plugin\",\n  \"list\": \"readme\"\n}"
    },
    "$:/plugins/BenSweaterVest/cloudflare-saver/saver.js": {
      "title": "$:/plugins/BenSweaterVest/cloudflare-saver/saver.js",
      "type": "application/javascript",
      "module-type": "saver",
      "text": "/*\\\ntitle: $:/plugins/BenSweaterVest/cloudflare-saver/saver.js\ntype: application/javascript\nmodule-type: saver\n\nCloudflare Functions saver for TiddlyWiki - Additional Saver Option\n\nThis saver allows TiddlyWiki to save to GitHub via a Cloudflare Function.\nIt works as an additional save option alongside other savers.\n\nFeatures:\n- Password authentication\n- Auto-retry with exponential backoff\n- Session password memory\n- Visual notifications\n- Comprehensive error handling\n\n\\*/\n(function(){\n\n\"use strict\";\n\n/**\n * CloudflareSaver constructor\n * @param {Object} wiki - TiddlyWiki wiki object\n */\nvar CloudflareSaver = function(wiki) {\n    this.wiki = wiki;\n    this.sessionPassword = null; // Store password for session if enabled\n};\n\nCloudflareSaver.prototype.save = function(text, method, callback, options) {\n    var self = this;\n    options = options || {};\n\n    // Check if this saver is enabled\n    var enabled = self.wiki.getTiddlerText(\"$:/config/cloudflare-saver/enabled\", \"no\") === \"yes\";\n    if(!enabled) {\n        return false; // Let other savers handle it\n    }\n\n    // Validate configuration before claiming to handle the save\n    var endpoint = self.wiki.getTiddlerText(\"$:/config/cloudflare-saver/endpoint\", \"\");\n    if(!endpoint || endpoint.trim() === \"\") {\n        return false; // Let other savers handle it if not configured\n    }\n\n    // We can handle save and autosave methods\n    if(method !== \"save\" && method !== \"autosave\") {\n        return false;\n    }\n\n    var config = {\n        endpoint: endpoint,\n        timeout: Math.max(5, parseInt(self.wiki.getTiddlerText(\"$:/config/cloudflare-saver/timeout\", \"30\")) || 30) * 1000,\n        notifications: self.wiki.getTiddlerText(\"$:/config/cloudflare-saver/notifications\", \"yes\") === \"yes\",\n        autoRetry: self.wiki.getTiddlerText(\"$:/config/cloudflare-saver/auto-retry\", \"yes\") === \"yes\",\n        rememberPassword: self.wiki.getTiddlerText(\"$:/config/cloudflare-saver/remember-password\", \"no\") === \"yes\",\n        debug: self.wiki.getTiddlerText(\"$:/config/cloudflare-saver/debug\", \"no\") === \"yes\"\n    };\n\n    if(config.debug) {\n        console.log(\"[CloudflareSaver] Starting save process\");\n    }\n\n    var password = null;\n    if(config.rememberPassword && self.sessionPassword) {\n        password = self.sessionPassword;\n    } else {\n        password = prompt(\"Enter Cloudflare save password:\");\n        if (!password) {\n            callback(\"Cloudflare save cancelled by user\");\n            return false;\n        }\n        if(config.rememberPassword) {\n            self.sessionPassword = password;\n        }\n    }\n\n    if(config.notifications && typeof $tw !== 'undefined' && $tw.notifier) {\n        $tw.notifier.display(\"$:/plugins/BenSweaterVest/cloudflare-saver/notifications/saving\");\n    }\n\n    self._performSave(text, password, callback, config, 0);\n    return true;\n};\n\nCloudflareSaver.prototype._performSave = function(text, password, callback, config, retryCount) {\n    var self = this;\n    var maxRetries = config.autoRetry ? 3 : 0;\n    \n    var xhr = new XMLHttpRequest();\n    xhr.open(\"POST\", config.endpoint, true);\n    xhr.setRequestHeader(\"Content-Type\", \"application/json\");\n    xhr.timeout = config.timeout;\n    \n    xhr.onload = function() {\n        if(xhr.status === 200) {\n            if(config.debug) {\n                console.log(\"[CloudflareSaver] Save successful\");\n            }\n            callback(null);\n            if(config.notifications && typeof $tw !== 'undefined' && $tw.notifier) {\n                $tw.notifier.display(\"$:/plugins/BenSweaterVest/cloudflare-saver/notifications/success\");\n            }\n        } else {\n            self._handleSaveError(xhr, password, text, callback, config, retryCount);\n        }\n    };\n    \n    xhr.onerror = function() {\n        self._handleSaveError(xhr, password, text, callback, config, retryCount);\n    };\n    \n    xhr.ontimeout = function() {\n        self._handleSaveError(xhr, password, text, callback, config, retryCount);\n    };\n    \n    try {\n        var payload = {\n            content: text,\n            password: password,\n            timestamp: new Date().toISOString(),\n            retryCount: retryCount\n        };\n        xhr.send(JSON.stringify(payload));\n    } catch(e) {\n        callback(\"Failed to send Cloudflare save request: \" + e.message);\n    }\n};\n\nCloudflareSaver.prototype._handleSaveError = function(xhr, password, text, callback, config, retryCount) {\n    var self = this;\n    var maxRetries = config.autoRetry ? 3 : 0;\n\n    var errorMsg = \"Cloudflare save failed\";\n    if(xhr.status) {\n        errorMsg += \": HTTP \" + xhr.status;\n        if(xhr.statusText) {\n            errorMsg += \" \" + xhr.statusText;\n        }\n    }\n\n    // Parse response for detailed error information\n    if(xhr.responseText) {\n        try {\n            var response = JSON.parse(xhr.responseText);\n            if(response.error) {\n                errorMsg += \" - \" + response.error;\n            }\n            // Add rate limit information if available\n            if(response.resetIn) {\n                errorMsg += \" (retry in \" + response.resetIn + \" seconds)\";\n            }\n        } catch(e) {\n            if(xhr.responseText.length < 200) {\n                errorMsg += \" - \" + xhr.responseText;\n            }\n        }\n    }\n\n    // Handle specific HTTP status codes\n    if(xhr.status === 401) {\n        self.sessionPassword = null;\n        errorMsg = \"Cloudflare authentication failed. Please check your password.\";\n    } else if(xhr.status === 429) {\n        errorMsg = \"Rate limit exceeded. Please wait a minute before trying again.\";\n    } else if(xhr.status === 413) {\n        errorMsg = \"Content too large. Your TiddlyWiki exceeds the maximum allowed size.\";\n    } else if(xhr.status === 409) {\n        errorMsg = \"Conflict detected. Another save may be in progress.\";\n    }\n\n    if(config.debug) {\n        console.error(\"[CloudflareSaver] Error:\", errorMsg, {\n            status: xhr.status,\n            retryCount: retryCount,\n            willRetry: retryCount < maxRetries && xhr.status !== 401\n        });\n    }\n\n    // Retry logic (don't retry auth failures or rate limits)\n    if(retryCount < maxRetries && xhr.status !== 401 && xhr.status !== 429) {\n        var retryDelay = Math.min(1000 * Math.pow(2, retryCount), 10000);\n        if(config.debug) {\n            console.log(\"[CloudflareSaver] Retrying in \" + (retryDelay / 1000) + \" seconds...\");\n        }\n        setTimeout(function() {\n            self._performSave(text, password, callback, config, retryCount + 1);\n        }, retryDelay);\n    } else {\n        callback(errorMsg);\n        if(config.notifications && typeof $tw !== 'undefined' && $tw.notifier) {\n            $tw.notifier.display(\"$:/plugins/BenSweaterVest/cloudflare-saver/notifications/failure\");\n        }\n    }\n};\n\nCloudflareSaver.prototype.info = {\n    name: \"cloudflare\",\n    priority: 2000, // High priority - when enabled, prefer this over download saver\n    capabilities: [\"save\", \"autosave\"]\n};\n\n// Export saver info at module level\nexports.info = {\n    name: \"cloudflare\",\n    priority: 2000,\n    capabilities: [\"save\", \"autosave\"]\n};\n\n// Export module-level functions as required by TiddlyWiki\nexports.canSave = function(wiki) {\n    // Use $tw.wiki global instead of wiki parameter during initialization\n    var enabled = $tw.wiki.getTiddlerText(\"$:/config/cloudflare-saver/enabled\", \"no\") === \"yes\";\n    var endpoint = $tw.wiki.getTiddlerText(\"$:/config/cloudflare-saver/endpoint\", \"\");\n    // Only claim we can save if both enabled AND endpoint is configured\n    return enabled && endpoint && endpoint.trim() !== \"\";\n};\n\nexports.create = function(wiki) {\n    return new CloudflareSaver(wiki);\n};\n\n})();\n\n"
    },
    "$:/plugins/BenSweaterVest/cloudflare-saver/startup.js": {
      "title": "$:/plugins/BenSweaterVest/cloudflare-saver/startup.js",
      "type": "application/javascript",
      "module-type": "startup",
      "text": "/*\\\ntitle: $:/plugins/BenSweaterVest/cloudflare-saver/startup.js\ntype: application/javascript\nmodule-type: startup\n\nStartup module for Cloudflare Saver plugin - Register as additional saver\n\\*/\n(function(){\n\n\"use strict\";\n\nexports.name = \"cloudflare-saver-startup\";\nexports.platforms = [\"browser\"];\nexports.after = [\"startup\"];\nexports.synchronous = true;\n\nexports.startup = function() {\n    // Don't automatically set as default saver - let users choose\n    \n    // Set up configuration defaults\n    var configDefaults = {\n        \"$:/config/cloudflare-saver/endpoint\": \"\",\n        \"$:/config/cloudflare-saver/timeout\": \"30\",\n        \"$:/config/cloudflare-saver/notifications\": \"yes\",\n        \"$:/config/cloudflare-saver/auto-retry\": \"yes\",\n        \"$:/config/cloudflare-saver/remember-password\": \"no\",\n        \"$:/config/cloudflare-saver/debug\": \"no\",\n        \"$:/config/cloudflare-saver/enabled\": \"no\"\n    };\n    \n    Object.keys(configDefaults).forEach(function(title) {\n        if(!$tw.wiki.getTiddler(title)) {\n            $tw.wiki.addTiddler(new $tw.Tiddler({\n                title: title,\n                text: configDefaults[title]\n            }));\n        }\n    });\n\n    var enabled = $tw.wiki.getTiddlerText(\"$:/config/cloudflare-saver/enabled\", \"no\") === \"yes\";\n    console.log(\"[CloudflareSaver] Plugin loaded successfully\" + (enabled ? \" and enabled\" : \" (disabled)\"));\n};\n\n})();\n\n"
    },
    "$:/plugins/BenSweaterVest/cloudflare-saver/settings": {
      "title": "$:/plugins/BenSweaterVest/cloudflare-saver/settings",
      "type": "text/vnd.tiddlywiki",
      "caption": "CloudFlare Saver",
      "tags": "$:/tags/ControlPanel/Saving",
      "text": "\\define config-base() $:/config/cloudflare-saver/\n\n!! ~CloudFlare Saver\n\n<$checkbox tiddler={{{ [<config-base>addsuffix[enabled]] }}} field=\"text\" checked=\"yes\" unchecked=\"no\" default=\"no\"> Enable saving to Cloudflare Functions</$checkbox>\n\n<div class=\"tc-control-panel-hint\">\nSave your TiddlyWiki to GitHub via Cloudflare Functions with password authentication. Works as an additional save option alongside your existing save methods.\n</div>\n\n<$reveal state={{{ [<config-base>addsuffix[enabled]] }}} type=\"match\" text=\"yes\" animate=\"yes\">\n\n!!! Cloudflare Function Endpoint URL\n\n<$edit-text tiddler={{{ [<config-base>addsuffix[endpoint]] }}} field=\"text\" default=\"\" placeholder=\"https://your-site.pages.dev/functions/save\" class=\"tc-edit-texteditor\"/>\n\n<div class=\"tc-control-panel-hint\">\nThe full URL to your deployed Cloudflare Function endpoint (e.g., `https://my-wiki.pages.dev/functions/save`)\n</div>\n\n!!! Advanced Options\n\n<$checkbox tiddler={{{ [<config-base>addsuffix[notifications]] }}} field=\"text\" checked=\"yes\" unchecked=\"no\" default=\"yes\"> Show save notifications</$checkbox>\n\n<$checkbox tiddler={{{ [<config-base>addsuffix[auto-retry]] }}} field=\"text\" checked=\"yes\" unchecked=\"no\" default=\"yes\"> Auto-retry failed saves (up to 3 attempts)</$checkbox>\n\n<$checkbox tiddler={{{ [<config-base>addsuffix[remember-password]] }}} field=\"text\" checked=\"yes\" unchecked=\"no\" default=\"no\"> Remember password during session</$checkbox>\n\n<div class=\"tc-control-panel-hint\">\n‚ö†Ô∏è Password is stored in memory only and cleared on page reload. Only enable on trusted devices.\n</div>\n\n<$checkbox tiddler={{{ [<config-base>addsuffix[debug]] }}} field=\"text\" checked=\"yes\" unchecked=\"no\" default=\"no\"> Enable debug logging to console</$checkbox>\n\n!!! Request Timeout\n\n<$edit-text tiddler={{{ [<config-base>addsuffix[timeout]] }}} field=\"text\" default=\"30\" class=\"tc-edit-texteditor\" size=\"10\"/> seconds\n\n<div class=\"tc-control-panel-hint\">\nHow long to wait for save requests before timing out (minimum 5 seconds)\n</div>\n\n!!! Setup Instructions\n\n<$details summary=\"Click to expand setup guide\">\n\n''1. Create Cloudflare Pages Site''\n\n# Go to [[Cloudflare Pages|https://pages.cloudflare.com/]]\n# Connect your GitHub account and create a Pages project from your TiddlyWiki repository\n# Deploy your site (e.g., `https://my-tiddlywiki.pages.dev`)\n\n''2. Create GitHub Personal Access Token''\n\n# Go to GitHub ‚Üí Settings ‚Üí Developer settings ‚Üí [[Personal access tokens|https://github.com/settings/tokens]]\n# Click \"Generate new token (classic)\"\n# Select scope: `repo` (Full control of private repositories)\n# Copy the token securely\n\n''3. Create Cloudflare Function''\n\nCreate a file at `functions/save.js` in your repository root. The complete, production-ready function code is available at:\n\nhttps://github.com/BenSweaterVest/tiddlywiki-cloudflare-saver/blob/main/demo/functions/save.js\n\nThe function includes password authentication, rate limiting, content validation, retry logic, and proper UTF-8 handling.\n\n''4. Set Environment Variables''\n\nIn Cloudflare Pages ‚Üí Settings ‚Üí Environment Variables ‚Üí Production:\n\n|!Variable |!Type |!Description |\n|`GITHUB_TOKEN` |üîê Secret |GitHub Personal Access Token (with `repo` scope) |\n|`GITHUB_REPO` |üìù Text |Repository in format `username/repo-name` |\n|`SAVE_PASSWORD` |üîê Secret |Password for authenticating saves |\n|`FILE_PATH` |üìù Text |Path to TiddlyWiki file (optional, default: `index.html`) |\n|`MAX_CONTENT_SIZE` |üìù Text |Max file size in bytes (optional, default: 52428800 = 50MB) |\n|`ALLOWED_ORIGINS` |üìù Text |Comma-separated origins for CORS (optional, default: `*`) |\n\nMark `GITHUB_TOKEN` and `SAVE_PASSWORD` as encrypted/secret variables.\n\n''5. Configure and Test''\n\n# Enter your Cloudflare Function URL above\n# Use the TiddlyWiki save button - you'll be prompted for your password\n# Check for success notification\n\n</$details>\n\n!!! Test Connection\n\n<$button class=\"tc-btn-big-green\">\n{{$:/core/images/save-button}} Test Cloudflare Save\n<$action-sendmessage $message=\"tm-save-wiki\" param=\"cloudflare\"/>\n</$button>\n\n<div class=\"tc-control-panel-hint\">\nThis will attempt to save your wiki to test the connection. You'll be prompted for your password.\n</div>\n\n</$reveal>\n"
    },
    "$:/plugins/BenSweaterVest/cloudflare-saver/readme": {
      "title": "$:/plugins/BenSweaterVest/cloudflare-saver/readme",
      "type": "text/vnd.tiddlywiki",
      "text": "!! Overview\n\nThis plugin enables saving your TiddlyWiki directly to a GitHub repository via Cloudflare Functions with secure password authentication, working as an additional save option alongside your existing save methods.\n\n!! Key Features\n\n* üîê **Secure**: Password-protected saves with environment variable storage\n* ‚ö° **Fast**: Serverless architecture via Cloudflare Functions\n* üîÑ **Reliable**: Built-in retry logic and comprehensive error handling\n* üì± **Responsive**: Visual notifications for save status\n* üõ†Ô∏è **Configurable**: Comprehensive settings panel with debug mode\n* ü§ù **Compatible**: Works alongside existing TiddlyWiki save methods\n\n!! Quick Setup\n\n# Go to Control Panel ‚Üí Saving tab\n# Find the CloudFlare Saver section\n# Enable saving to Cloudflare Functions\n# Follow the setup guide to configure your Cloudflare Function endpoint\n# Test the connection using the built-in test button\n\n!! How It Works\n\nThis plugin adds Cloudflare saving as an additional option to your existing save methods. When enabled, you can save your TiddlyWiki through a Cloudflare Function that securely commits changes to your GitHub repository.\n\n!! Support\n\nFor detailed setup instructions, troubleshooting, and support:\nhttps://github.com/BenSweaterVest/tiddlywiki-cloudflare-saver\n\n!! Version\n\nVersion 1.0.0 - Initial release with full functionality and comprehensive documentation.\n\n"
    },
    "$:/plugins/BenSweaterVest/cloudflare-saver/notifications/failure": {
      "title": "$:/plugins/BenSweaterVest/cloudflare-saver/notifications/failure",
      "type": "text/vnd.tiddlywiki",
      "text": "<div class=\"tc-notification-banner tc-notification-banner-error\">\n<$button class=\"tc-btn-invisible tc-notification-btn\" message=\"tm-close-tiddler\">{{$:/core/images/close-button}}</$button>\n{{$:/core/images/warning}} Save failed. Check console for details.\n</div>\n"
    },
    "$:/plugins/BenSweaterVest/cloudflare-saver/notifications/saving": {
      "title": "$:/plugins/BenSweaterVest/cloudflare-saver/notifications/saving",
      "type": "text/vnd.tiddlywiki",
      "text": "<div class=\"tc-notification-banner\">\n<$button class=\"tc-btn-invisible tc-notification-btn\" message=\"tm-close-tiddler\">{{$:/core/images/close-button}}</$button>\n<span class=\"tc-notification-loading\">{{$:/core/images/spiral}}</span> Saving to GitHub via Cloudflare...\n</div>\n"
    },
    "$:/plugins/BenSweaterVest/cloudflare-saver/notifications/success": {
      "title": "$:/plugins/BenSweaterVest/cloudflare-saver/notifications/success",
      "type": "text/vnd.tiddlywiki",
      "<$button class=\"tc-btn-invisible tc-notification-btn\" message=\"tm-close-tiddler\">{{$": "/core/images/close-button}}</$button>",
      "{{$": "/core/images/done-button}} Successfully saved to GitHub!",
      "text": ""
    }
  }
}